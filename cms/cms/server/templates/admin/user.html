{% extends base.html %}

{% block core %}

<h1>{{ selected_user.real_name }} ({{ selected_user.username }})</h1>
<h2 id="title_submissions" class="toggling_on" onclick="utils.toggle_visibility('submissions');">Submissions</h2>
<div id="submissions">

  {% if submissions == [] %}
  <p>No submissions found.</p>

  {% else %}
  <table class="bordered">
    <thead>
      <tr>
        <th style="width: 13%">Date</th>
        <th style="width: 13%">Task</th>
        <th style="width: 35%">Evaluation</th>
        <th style="width: 15%">Files</th>
        <th style="width: 12%">Released</th>
        <th style="width: 12%">Reevaluate</th>
      </tr>
    </thead>
    <tbody>
      {% for s in sorted(submissions, key=lambda s: s.timestamp, reverse=True) %}
      <tr>
        <td>
          {{ Utils.format_time_or_date(s.timestamp) }}
        </td>
        <td>
          {{ s.task.name }}
        </td>
        <td>
          {% if s.compilation_outcome is None %}
          Compiling

          {% else %}
          <div id="title_evaluation_{{ s.id }}" class="toggling_off" onclick="utils.toggle_visibility('evaluation_{{ s.id }}');">
            {% if s.compilation_outcome == "fail" %}
            Compilation failed
            {% elif s.evaluations == [] %}
            Evaluating
            {% else %}
            Evaluated
            {% end %}
          </div>
          <div id="evaluation_{{ s.id }}" style="display: none;">
            {% if s.evaluations != [] %}
              {% if s.token is None %}
            <h3>Public testcases</h3>
              {% else %}
            <h3>Detailed feedback</h3>
              {% end %}
            <table class="nested bordered">
              <thead>
                <tr>
                  <th style="width: 20%">Outcome</th>
                  <th style="width: 80%">Details</th>
                </tr>
              </thead>
              <tbody>
                {% for ev in s.evaluations %}
                  <tr><td>{{ escape(ev.outcome) }}</td><td>{{ escape(ev.text) }}</td></tr>
                {% end %}
              </tbody>
            </table>
            {% end %}
            <h3>Compilation output</h3><!-- TODO: trim long outputs and add facility to see raw -->
            <pre>{% if s.compilation_text != None %}{{ escape(s.compilation_text) }}{% end %}</pre>
          </div>

          {% end %}
        </td>
        <td>
          {% for filename,sub_file in s.files.items() %}
          <a href="/submission_file/{{ sub_file.id }}">{{ escape(filename) }}<br/>
          {% end %}
        </td>
        <td>
          {% if s.token is None %}
          No
          {% else %}
          Yes
          {% end %}
        </td>
        <td>
          <a href="/reevaluate/submission/{{s.id}}">Go ahead!</a>
        </td>
      </tr>
      {% end %}
    </tbody>
  </table>
  {% end %}
  <div class="hr"></div>
</div>

<h2 id="title_messages" class="toggling_on" onclick="utils.toggle_visibility('messages');">Messages</h2>
<div id="messages">
  {% if selected_user.messages != [] %}
  <div class="notifications">
    {% for msg_i, msg in enumerate(selected_user.messages) %}
    <div class="notification communication">
      <div class="notification_msg">
        <div class="notification_timestamp">{{ Utils.format_time_or_date(msg.timestamp) }}</div>
        <div class="notification_subject">{{ msg.subject }}</div>
        <div class="notification_text">{{ msg.text }}</div>
      </div>
    </div>
    {% end %}
  </div>

  {% else %}
  No messages.

  {% end %}
  <h2>Send message</h2>


  <form id="send_message_form" action="/message/{{selected_user.id}}" method="POST">
    Subject: <input id="send_message_subject" type="text" name="send_message_subject"></br>
    Text: <textarea name="send_message_text"></textarea><br/>
    <input type="submit" value="Send"/>
  </form>
  <div class="hr"></div>
</div>

    <script>
function question_reply_toggle(element, invoker)
{
  var obj = document.getElementsByClassName("reply_question")[element];
  if (obj.style.display != "block")
    {
      obj.style.display = "block";
      invoker.innerHTML = "Hide reply";
    }
  else
    {
      obj.style.display = "none";
      invoker.innerHTML = "Reply";
    }
  return false;
}

function update_additional_answer(element, invoker)
{
  var obj = document.getElementsByClassName("alternative_answer")[element];
  if (invoker.selectedIndex == 5)
    obj.style.display = "block";
  else
    obj.style.display = "none";
}
    </script>

    <h2 onclick="util.toggle_visibility(&quot;user_questions&quot;);">
      <span class="toggle" id="user_questions_toggle">-</span>Submitted questions
    </h2>
    <div id="user_questions">
      {% if selected_user.questions != [] %}
        {% for i, question in enumerate(reversed(selected_user.questions)) %}
      <div class="question_item displayed">
        <div class="question_content">
          <span class="question_date">{{ datetime.datetime.fromtimestamp(question.question_timestamp).strftime("%d/%m/%Y %H:%M:%S")  }}</span>
          <span class="question_subject">{{escape(question.subject)}}</span>
          <span class="question_text">{{escape(question.text)}}</span>
          <hr/>
          <div class="reply_question_quick_answer">
            {% if WebConfig.quick_answers.get(question.short_reply, None) != None %}
            Reply (precompiled): &ldquo;{{ WebConfig.quick_answers.get(msg.short_reply, "") }}&rdquo;.
            {% elif question.long_reply != None %}
            Reply: &ldquo;{{ escape(question.long_reply) }}&rdquo;.
            {% else %}
            Not yet replied.
            {% end %}
          </div>
          <div class="reply_question_toggle">
            <a href="#" onclick="return question_reply_toggle({{ i }}, this);">Reply</a>
          </div>
        </div>
        <div class="reply_question" >
          <hr/>
          <form class="reply_question_form" action="/question/{{question.id}}" method="POST">
            Precompiled answer:
            <select name="reply_question_quick_answer" onchange="update_additional_answer({{ i }}, this);">
              <option value="yes">Yes</option>
              <option value="no">No</option>
              <option value="answered">Answered in task description</option>
              <option value="invalid">Invalid question</option>
              <option value="nocomment">No comment</option>
              <option selected value="other">Other</option>
            </select>
            <br/>
            <div class="alternative_answer">
              Alternative answer:<br/>
              <textarea name="reply_question_text"></textarea><br/>
            </div>
            <input type="submit" value="Send"/>
          </form>
        </div>
      </div>
        {% end %}
      {% else %}
      No submitted questions.
      {% end %}
    </div>

{% end %}
