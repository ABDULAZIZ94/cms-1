{% extends base.html %}

{% block js %}

function update_submissions_status(response)
{
    var table = document.getElementById("submissions_status_table");
    while (table.rows.length > 1)
        table.deleteRow(1);
    if (response['status'] == 'unconnected')
        table.insertRow(-1).innerHTML = "<td colspan='2'>EvaluationService not connected.</td>";
    else if (response['status'] == 'not authorized')
        table.insertRow(-1).innerHTML = "<td colspan='2'>You are not authorized to see the queue status.</td>";
    else if (response['status'] == 'fail')
        table.insertRow(-1).innerHTML = "<td colspan='2'>Call to EvaluationService failed.</td>";
    else if (response['status'] == 'ok')
    {
        table.insertRow(-1).innerHTML = '<td>Evaluated</td><td>' + response['data']['evaluated'] + '</td>';
        if (response['data']['compilation_fail'] != 0)
          table.insertRow(-1).innerHTML = '<td>Compilation failed</td><td>' + response['data']['compilation_fail'] + '</td>';
        if (response['data']['compiling'] != 0)
          table.insertRow(-1).innerHTML = '<td>Compiling...</td><td>' + response['data']['compiling'] + '</td>';
        if (response['data']['evaluating'] != 0)
          table.insertRow(-1).innerHTML = '<td>Evaluating...</td><td>' + response['data']['evaluating'] + '</td>';
        if (response['data']['max_compilations'] != 0)
          table.insertRow(-1).innerHTML = '<td>Cannot compile (please check)</td><td>' + response['data']['max_compilations'] + '</td>';
        if (response['data']['max_evaluations'] != 0)
          table.insertRow(-1).innerHTML = '<td>Cannot evaluate (please check)</td><td>' + response['data']['max_evaluations'] + '</td>';
        if (response['data']['invalid'] != 0)
          table.insertRow(-1).innerHTML = '<td>Invalid (please check)</td><td>' + response['data']['invalid'] + '</td>';
    }
    else
        table.insertRow(-1).innerHTML = "<td colspan='5'>Unexpected reply. This should not happen.</td>";
};

function update_queue_status(response)
{
    var table = document.getElementById("queue_status_table");
    while (table.rows.length > 1)
        table.deleteRow(1);
    if (response['status'] == 'unconnected')
        table.insertRow(-1).innerHTML = "<td colspan='5'>EvaluationService not connected.</td>";
    else if (response['status'] == 'not authorized')
        table.insertRow(-1).innerHTML = "<td colspan='5'>You are not authorized to see the queue status.</td>";
    else if (response['status'] == 'fail')
        table.insertRow(-1).innerHTML = "<td colspan='5'>Call to EvaluationService failed.</td>";
    else if (response['status'] == 'ok')
    {
        if (response['data'].length == 0)
            table.insertRow(-1).innerHTML = "<td colspan='5'>Queue empty.</td>";
        else
        {
            for (var i = 0; i < response['data'].length; i++)
            {
                var row = table.insertRow(-1);
                var job = utils.repr_job(response['data'][i]['job']);
                var date = utils.repr_time_ago(response['data'][i]['timestamp']);
                row.innerHTML = '<td>' + (i + 1) + '</td>' +
                    '<td>' + job + '</td>' +
                    '<td>' + response['data'][i]['priority'] + '</td>' +
                    '<td>' + date + '</td>';
            }
        }
    }
    else
        table.insertRow(-1).innerHTML = "<td colspan='5'>Unexpected reply. This should not happen.</td>";
};

function update_workers_status(response)
{
    var table = document.getElementById("workers_status_table");
    while (table.rows.length > 1)
        table.deleteRow(1);
    if (response['status'] == 'unconnected')
        table.insertRow(-1).innerHTML = "<td colspan='5'>EvaluationService not connected.</td>";
    else if (response['status'] == 'not authorized')
        table.insertRow(-1).innerHTML = "<td colspan='5'>You are not authorized to see the workers status.</td>";
    else if (response['status'] == 'fail')
        table.insertRow(-1).innerHTML = "<td colspan='5'>Call to EvaluationService failed.</td>";
    else if (response['status'] == 'ok')
    {
        if (response['data'].length == 0)
            table.insertRow(-1).innerHTML = "<td colspan='5'>No workers found.</td>";
        else
        {
            for (var i in response['data'])
            {
                var row = table.insertRow(-1);
                var job = utils.repr_job(response['data'][i]['job']);
                var start_time = utils.repr_time_ago(response['data'][i]['start_time']);
                var connected = "Yes";
                if (response['data'][i]['connected'] == false)
                    connected = "No";
                row.innerHTML = '<td>' + i + '</td>' +
                    '<td>' + connected + '</td>' +
                    '<td>' + response['data'][i]['error_count'] + '</td>' +
                    '<td>' + job + '</td>' +
                    '<td>' + start_time + '</td>';
            }
        }
    }
    else
        table.insertRow(-1).innerHTML = "<td colspan='5'>Unexpected reply. This should not happen.</td>";
};

function link_submissions(s)
{
    return s.replace(/submission ([0-9]+)/g,
                     'submission <a href="/submission/$1">\$1</a>');
}

function update_logs(response)
{
    var table = document.getElementById("logs_table");
    while(table.rows.length > 1)
        table.deleteRow(1);

    if (response['status'] == 'unconnected')
        table.insertRow(-1).innerHTML = "<td colspan='5'>LogService not connected.</td>";
    else if (response['status'] == 'not authorized')
        table.insertRow(-1).innerHTML = "<td colspan='5'>You are not authorized to see the logs.</td>";
    else if (response['status'] == 'fail')
        table.insertRow(-1).innerHTML = "<td colspan='5'>Call to LogService failed.</td>";
    else if (response['status'] == 'ok')
    {
        if (response['data'].length == 0)
            table.insertRow(-1).innerHTML = "<td colspan='5'>No log entries.</td>";
        else
        {
            response['data'] = response['data'].reverse()
            for (i in response['data'])
            {
                var row = table.insertRow(-1);
                var message = link_submissions(response['data'][i]['message']);
                var coord = response['data'][i]['coord'];
                var operation = link_submissions(response['data'][i]['operation']);
                var severity = response['data'][i]['severity'];
                var timestamp = utils.format_time_or_date(response['data'][i]['timestamp']);

                row.innerHTML = '<td>' + timestamp + '</td>' +
                    '<td>' + severity + '</td>' +
                    '<td>' + coord + '</td>' +
                    '<td>' + operation + '</td>' +
                    '<td>' + message + '</td>';
            }
        }
    }
    else
        table.insertRow(-1).innerHTML = "<td colspan='5'>Unexpected reply. This should not happen.</td>";
}

function update_statuses()
{

    cmsrpc.request("EvaluationService", 0,
                   "submissions_status",
                   {},
                   update_submissions_status);
    cmsrpc.request("EvaluationService", 0,
                   "queue_status",
                   {},
                   update_queue_status);
    cmsrpc.request("EvaluationService", 0,
                   "workers_status",
                   {},
                   update_workers_status);
    cmsrpc.request("LogService", 0,
                   "last_messages",
                   {},
                   update_logs);
}

{% end %}

{% block js_init %}

setInterval(update_statuses, 5000);
update_statuses();

{% end %}

{% block core %}

<h1>Overview</h1>
<span id="update_time"></span>

{% if contest is not None %}
<h2 id="title_submissions_status" class="toggling_on" onclick="utils.toggle_visibility('submissions_status');">Submissions status</h2>
<div id="submissions_status">

<table id="submissions_status_table" class="sub_table">
  <thead>
    <tr>
      <th style="width:80%">Status</th>
      <th style="width:20%">Number</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>
{% end %}

<h2 id="title_queue_status" class="toggling_on" onclick="utils.toggle_visibility('queue_status');">Queue status</h2>
<div id="queue_status">

<table id="queue_status_table" class="sub_table">
  <thead>
    <tr>
      <th style="width:10%">Id</th>
      <th style="width:65%">Job</th>
      <th style="width:10%">Priority</th>
      <th style="width:15%">Since</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>

<h2 id="title_workers_status" class="toggling_on" onclick="utils.toggle_visibility('workers_status');">Workers status</h2>
<div id="workers_status">

<table id="workers_status_table" class="sub_table">
  <thead>
    <tr>
      <th style="width:15%">Shard</th>
      <th style="width:15%">Connected</th>
      <th style="width:15%">Errors</th>
      <th style="width:40%">Current job</th>
      <th style="width:15%">Since</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

</div>

<h2 id="title_logs" class="toggling_on" onclick="utils.toggle_visibility('logs');">Logs</h2>
<div id="logs">

<table id="logs_table" class="sub_table">
  <thead>
    <tr>
      <th style="width:12%">Time</th>
      <th style="width:10%">Severity</th>
      <th style="width:15%">Service</th>
      <th style="width:25%">Operation</th>
      <th style="width:38%">Message</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

</div>
{% end %}
