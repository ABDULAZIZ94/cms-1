{% extends base.html %}
{% block js %}

function __received_file(response, file_name)
{

    var escaped_response = response.replace("<","&lt;").replace(">","&gt;");
    var pre_class="";
    if(file_name.match(/.c(|pp)$/i))
    {
      pre_class = "brush: cpp";
    }
    else if (file_name.match(/.pas$/i))
    {
      pre_class = "brush: delphi";
    }
    var page = "<h1>" + file_name + "</h1>" + 
                "<pre id=\"source_container\" class=\"" + pre_class + "\">" +
                escaped_response + "</pre>";

    utils.display_subpage(page);
    SyntaxHighlighter.highlight()
}

function show_file(file_name, url)
{
    cmsutils.ajax_request(url, null, 
      function(response){
        __received_file(response, file_name);
      }
    );
}

{% end %}
{% block core %}

<h1>{{ task.title }} ({{ task.name }})</h1>

<h2 id="title_task_information" class="toggling_on" onclick="utils.toggle_visibility('task_information');">{{ _("Task information") }}</h2>
<div id="task_information">
  <div><a href="/tasks/{{ task.name }}/statement">{{ _("Download task statement") }}</a></div>

  {{ _("Time limit: %(seconds)s second(s).") % {"seconds": task.time_limit} }}</br>
  {{ _("Memory limit: %(mb)s MB.") % {"mb": task.memory_limit} }}</br>
  <div class="hr"></div>
</div>


<h2 id="title_submit_solution" class="toggling_on" onclick="utils.toggle_visibility('submit_solution');">{{ _("Submit a solution") }}</h2>
<div id="submit_solution">
  <form enctype="multipart/form-data" action="/submit/{{ task.name }}" method="post">
    <input type="file" name="{{ task.name }}"></input>
    <input type="submit" value="{{ _("Submit") }}"></input>
  </form>
  <div class="hr"></div>
</div>


<h2 id="title_previous_submissions" class="toggling_on" onclick="utils.toggle_visibility('previous_submissions');">{{ _("Previous submissions") }}</h2>
<div id="previous_submissions">
  <div class="task_tokens">
    {% set tokens_info = contest.tokens_available(current_user.username, task.name, timestamp) %}
    {% set can_play_token = (tokens_info[0] > 0 and tokens_info[2] is None) %}
    {% if tokens_info[0] > 0 and tokens_info[2] is None %}
    <p>
      {{ _("Right now, you have %(tokens)s token(s) available on this task.") % { "tokens": tokens_info[0]} }}
      {% if tokens_info[1] is not None %}
      {{ _("You will receive a new token at %(gen_time)s.") % {"gen_time": Utils.format_time_or_date(tokens_info[1])} }}
      {% else %}
      {{ _("In the current situation, no more tokens will be generated.") }}
      {% end %}
    </p>
    {% elif tokens_info[0] > 0 %}
    <p>
      {{ _("Right now, you have %(tokens)s token(s) available on this task.") % { "tokens": tokens_info[0]} }}
      {{ _("But you have to wait until %(expiration_time)s to use them.") % {"expiration_time": Utils.format_time_or_date(tokens_info[2])} }}
      {% if tokens_info[1] is not None %}
      {{ _("You will receive a new token at %(gen_time)s.") % {"gen_time": Utils.format_time_or_date(tokens_info[1])} }}
      {% else %}
      {{ _("In the current situation, no more tokens will be generated.") }}
      {% end %}
    </p>
    {% else %}
    <p>
      {{ _("Right now, you do not have tokens available for this task.") }}
      {% if tokens_info[1] is not None %}
      {{ _("You will receive a new token at %(gen_time)s.") % {"gen_time": Utils.format_time_or_date(tokens_info[1])} }}
        {% if tokens_info[2] is not None and tokens_info[2] > tokens_info[1] %}
      {{ _("But you will have to wait until %(expiration_time)s to use it.") % {"expiration_time": Utils.format_time_or_date(tokens_info[2])} }}
        {% end %}
      {% else %}
      {{ _("In the current situation, no more tokens will be generated.") }}
      {% end %}
    </p>
    {% end %}
  </div>

  {% if submissions == [] %}
  <p>{{ _("No submissions found.") }}</p>

  {% else %}
  <table class="bordered">
    <thead>
      <tr>
        <th style="width: 13%">{{ _("Date") }}</th>
        <th style="width: 60%">{{ _("Evaluation") }}</th>
        <th style="width: 15%">{{ _("Files") }}</th>
        <th style="width: 12%">{{ _("Token used?") }}</th>
      </tr>
    </thead>
    <tbody>
      {% for s in sorted(submissions, key=lambda s: s.timestamp, reverse=True) %}
      <tr>
        <td>
          {{ Utils.format_time_or_date(s.timestamp) }}
        </td>
        <td>
          {% if s.compilation_outcome is None %}
          {{ _("Compiling...") }}

          {% else %}
          <div id="title_evaluation_{{ s.id }}" class="toggling_off" onclick="utils.toggle_visibility('evaluation_{{ s.id }}');">
            {% if s.compilation_outcome == "fail" %}
            {{ _("Compilation failed") }}
            {% elif s.evaluations == [] %}
            {{ _("Evaluating...") }}
            {% else %}
            {{ _("Evaluated") }}
            {% end %}
          </div>
          <div id="evaluation_{{ s.id }}" style="display: none;">
            {% if s.evaluations != [] %}
              {% if s.token is None %}
            <h3>{{ _("Public testcases") }}</h3>
              {% else %}
            <h3>{{ _("Detailed feedback") }}</h3>
              {% end %}
            <table class="nested bordered">
              <thead>
                <tr>
                  <th style="width: 20%">{{ _("Outcome") }}</th>
                  <th style="width: 80%">{{ _("Details") }}</th>
                </tr>
              </thead>
              <tbody>
                {% for ev in s.evaluations %}
                  {% if s.token is not None or s.task.testcases[int(ev.num)].public %}
                  <tr><td>{{ escape(ev.outcome) }}</td><td>{{ escape(ev.text) }}</td></tr>
                  {% end %}
                {% end %}
                {% if s.token is None and not any([testcase.public for testcase in s.task.testcases]) %}
                <tr><td colspan="2">{{ _("No specified testcases for partial feedback for this task.") }}</td></tr>
                {% end %}
              </tbody>
            </table>
            {% end %}
            <h3>{{ _("Compilation output") }}</h3><!-- TODO: trim long outputs and add facility to see raw -->
            <pre>{% if s.compilation_text is not None %}{{ escape(s.compilation_text) }}{% end %}</pre>
          </div>

          {% end %}
        </td>
        <td>
          {% for filename,sub_file in s.files.items() %}
          <a href="#" 
             onclick="show_file('{{ filename }}', '/submission_file/{{ encrypt_number(sub_file.id) }}');">
              {{ escape(filename) }}
          </a>
          <br/>
          {% end %}
            <td>
              {% if s.token is None %}
              {{ _("No") }}
                {% if can_play_token %}
              <form style="display: inline;" class="submit_form" action="/usetoken" method="POST">
                <input type="hidden" name="submission_id" value="{{ encrypt_number(s.id) }}" />
                <input type="submit" value="{{ _("Use!") }}" />
              </form>
                {% end %}
              {% else %}
              {{ _("Yes") }}
              {% end %}
      </tr>
      {% end %}
    </tbody>
  </table>
  {% end %}
</div>

{% end %}
